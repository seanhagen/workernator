package library

import (
	"context"
	"fmt"
	"os/exec"
	"time"
)

// JobStatus is used to define the potential statuses for a job
type JobStatus int

const (
	// Unknown is the default value, and should be treated as an error
	Unknown JobStatus = iota
	// Running means the job is still executing
	Running JobStatus = iota
	// Failed means the job returned an error and did not complete successfully
	Failed JobStatus = iota
	// Finished means the job completed successfully
	Finished JobStatus = iota
	// Stopped means the job was stopped/killed before it could complete
	Stopped JobStatus = iota
)

// NewErrInvalidID builds a custom ErrInvalidID and returns it
func NewErrInvalidID(id string, err error) error {
	return ErrInvalidID{id, err}
}

// NewErrNoJobForID builds a custom ErrNoJobForID and returns it
func NewErrNoJobForID(id string) error {
	return ErrNoJobForID{id}
}

// ErrInvalidID is a custom error for when JobStatus(), StopJob(), or
// GetJobOutput() is called with an ID that is not a valid xid
type ErrInvalidID struct {
	id  string
	err error
}

func (inv ErrInvalidID) Error() string {
	return fmt.Sprintf("'%v' is not a valid job id: %v", inv.id, inv.err)
}

// ErrNoJobForID is a custom error for when JobStatus(), StopJob(), or
// GetJobOutput() is called with an ID that the manager doesn't know
// about
type ErrNoJobForID struct {
	id string
}

func (no ErrNoJobForID) Error() string {
	return fmt.Sprintf("no job found for id '%v'", no.id)
}

// Job contains information about a running job, and also provides the
// ability to wait for a job to finish or to stop the job early.
type Job struct {
	JobInfo

	cmd  *exec.Cmd
	done context.Context
}

// SetCommand is used by the manager to set the *exec.Cmd run by this
// job.
func (j *Job) SetCommand(cmd *exec.Cmd) {
	j.cmd = cmd
}

// SetContext is used by the manager to set the context.Context used
// when waiting for a job to complete.
func (j *Job) SetContext(ctx context.Context) {
	j.done = ctx
}

// Stop forceably stops the job ( by killing it ), returning the error
// ( if any ) returned from the system when trying to kill the
// job. This should be set by the job manager.
func (j *Job) Stop() error {
	err := j.cmd.Process.Kill()
	<-j.done.Done()
	return err
}

// Wait is a function that blocks until the job is complete, at
// which point it returns the error ( if any ) generated by running
// the command. This should be set by the job manager.
func (j *Job) Wait() error {
	<-j.done.Done()
	return j.Error
}

// Info  ...
func (j *Job) Info() JobInfo {
	return j.JobInfo
}

// Finished ...
func (j *Job) Finished() bool {
	return !j.Ended.IsZero()
}

// JobInfo contains information about a job, whether it's running or
// finished.
type JobInfo struct {
	ID        string
	Status    JobStatus
	Command   string
	Arguments []string
	Error     error
	Started   time.Time
	Ended     time.Time
}
