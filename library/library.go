package library

import (
	"fmt"
	"time"
)

// JobStatus is used to define the potential statuses for a job
type JobStatus int

const (
	// Unknown is the default value, and should be treated as an error
	Unknown JobStatus = iota
	// Running means the job is still executing
	Running JobStatus = iota
	// Failed means the job returned an error and did not complete successfully
	Failed JobStatus = iota
	// Finished means the job completed successfully
	Finished JobStatus = iota
	// Stopped means the job was stopped/killed before it could complete
	Stopped JobStatus = iota
)

// NewErrInvalidID builds a custom ErrInvalidID and returns it
func NewErrInvalidID(id string, err error) error {
	return ErrInvalidID{id, err}
}

// NewErrNoJobForID builds a custom ErrNoJobForID and returns it
func NewErrNoJobForID(id string) error {
	return ErrNoJobForID{id}
}

// ErrInvalidID is a custom error for when JobStatus(), StopJob(), or
// GetJobOutput() is called with an ID that is not a valid xid
type ErrInvalidID struct {
	id  string
	err error
}

func (inv ErrInvalidID) Error() string {
	return fmt.Sprintf("'%v' is not a valid job id: %v", inv.id, inv.err)
}

// ErrNoJobForID is a custom error for when JobStatus(), StopJob(), or
// GetJobOutput() is called with an ID that the manager doesn't know
// about
type ErrNoJobForID struct {
	id string
}

func (no ErrNoJobForID) Error() string {
	return fmt.Sprintf("no job found for id '%v'", no.id)
}

// Job is an interface that can be used to interact with a job
type Job interface {
	JobInfo
	// Wait blocks until the job is complete, at which point it returns
	// the error ( if any ) generated by running the command
	Wait() error
	// Stop forceably stops the job ( by killing it ), returning the
	// error ( if any ) returned from the system when trying to kill the
	// job
	Stop() error
}

// JobInfo is an interface describing the state of a job
type JobInfo interface {
	// ID returns the unique string identifier for the job
	ID() string
	// Status returns the current status of the job, can be one of:
	//  - Unknown
	//  - Running
	//  - Failed
	//  - Finished
	//  - Stopped
	Status() JobStatus
	// Command returns the command that this job is running
	Command() string
	// Arguments returns the arguments pass to the job on the command
	// line
	Arguments() []string
	// Error returns nil until the job is finished; at which point it
	// will return the error ( if any ) generated by running the command
	Error() error
	// Started returns the time the job was started at
	Started() time.Time
	// Ended returns the time the job finshed at, or the zero value for time if the job is sitll running
	Ended() time.Time
}
